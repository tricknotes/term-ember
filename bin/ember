#!/usr/bin/env node

var path = require('path');

var ember   = require('../');
var package = require('../package');

var program = require('commander');

var pageUrl = __dirname + '/../vender/index.html';

program.version(package.version)
  .option('--ember <version>',      'A version of Ember.js (defaults to 1.0.0-rc3)')
  .option('--handlebars <version>', 'A version of Handlebars (defaults to 1.0.0.rc3)')
  .option('--jquery <version>',     'A version of jQuery (defaults to 1.9.1)')
  .option('--clear',                'Clear cached JavaScript libraries')

program
  .parse(process.argv);

if (program.clear) {
  ember.manager.clearCaches();
  process.exit(0);
}

var files = program.args;

program.ember       = program.ember       || '1.0.0-rc.3';
program.handlebars  = program.handlebars  || '1.0.0-rc.3';
program.jquery      = program.jquery      || '1.9.1';

ember
  .setup('ember',       program.ember)
  .setup('handlebars',  program.handlebars)
  .setup('jquery',      program.jquery)
  .then(function() {
    if (files.length > 0) {
      var runner = ember.run('file://' + pageUrl, process.stdin, process.stdout, {prompt: ''});

      runner.on('ready', function(window) {
        var Ember = window.Ember;

        files.forEach(function(file) {
          file = path.relative(__dirname, file);
          window.require(file);
        });
        // TODO Wait timers are free
        setInterval(function() {
          if (!Ember.run.hasScheduledTimers()) {
            process.exit(0);
          }
        }, 10);
      });
    } else {
      ember.run('file://' + pageUrl, process.stdin, process.stdout);
    }
  });
